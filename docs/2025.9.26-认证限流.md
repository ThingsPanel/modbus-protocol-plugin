# 接入服务认证限流

## 问题背景

**业务流程**: 设备 → 设备接入服务 → 平台

**问题现象**: 部分设备在认证失败后会立即无间隔重试，导致：
- 平台持续输出大量错误日志
- 数据库频繁查询，增加系统负载
- 影响系统整体性能和稳定性

## 解决方案

基于当前代码架构分析，认证发生在设备连接验证环节。当设备发送注册包时，系统会向平台验证设备合法性。

### 基于IP的简单计数限流

**核心机制**：为每个IP维护失败计数器，达到阈值后临时封禁该IP。

**限流策略**：
- 为每个IP地址维护失败计数器
- 认证失败时计数器+1
- 当计数器达到阈值时，将该IP加入黑名单
- 认证成功时清零计数器
- 定期清理过期的封禁记录

**配置参数**：
- `failure_threshold`: 失败阈值（建议：3次）
- `block_duration`: 封禁时长（建议：3分钟）
- `cleanup_interval`: 清理过期记录间隔（建议：1小时）

**处理流程**：
1. 提取客户端IP地址
2. 检查IP是否在封禁期内，如是则直接断开连接
3. 执行原有认证逻辑
4. 认证失败：增加该IP失败计数，达到阈值则封禁
5. 认证成功：清零该IP失败计数

**方案优点**：
- 实现简单，内存占用小
- 能有效阻止恶意重试攻击
- 对正常设备友好，偶尔失败不会被误伤
- 性能影响最小

**配置文件扩展**：

在配置文件中添加限流相关配置项：
- `enabled`: 是否启用认证限流（默认：true）
- `failure_threshold`: 失败阈值（默认：3次）
- `block_duration`: 封禁时长（默认：3分钟）
- `cleanup_interval`: 清理间隔（默认：1小时）

### 监控指标

建议添加以下监控指标：
- 认证失败次数统计
- 限流触发次数统计
- 当前被限流的IP数量
- 平均认证响应时间

### 部署建议

1. **渐进式部署**：先以较宽松的参数上线，观察效果后逐步收紧
2. **白名单机制**：为重要设备或可信IP提供白名单功能
3. **告警机制**：当限流触发频繁时及时告警
4. **日志记录**：详细记录限流事件，便于问题排查

### 预期效果

- **减少系统负载**：大幅降低恶意或异常设备对系统的冲击
- **提升稳定性**：避免认证服务被大量请求压垮
- **保护数据库**：减少无效的数据库查询
- **改善用户体验**：正常设备不受影响，异常设备被有效控制